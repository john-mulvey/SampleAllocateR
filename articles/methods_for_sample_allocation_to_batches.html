<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Methods for Allocating Samples to Batches • SampleAllocateR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Methods for Allocating Samples to Batches">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SampleAllocateR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/methods_for_sample_allocation_to_batches.html">Methods for Allocating Samples to Batches</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Methods for Allocating Samples to Batches</h1>
            
      

      <div class="d-none name"><code>methods_for_sample_allocation_to_batches.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Especially as the costs of performing assays has decreased, there has
been a move from analysing few samples from carefully controlled
experiments to analysing many samples directly from patient population
of interest. Controlled experiments are performed in experimental model
systems in order that covariates can be held constant across all
experimental units, whereas in clinical samples there will commonly be
number of covariates that also impact upon the dependent variable of
interest. Performing assays on a large number of samples requires that
the be analysed in <em>batches</em>, which results in technical
variation that should be accounted for in the analysis.</p>
<p>Here we demonstrate a tool to allocate pre-selected samples into
these technical batches in a way that maximises the balance of specified
covariates. By maximising the balance we maximise our ability to
separate technical batch variation from biological effects of interest.
This increases the precision of our estimates by reducing the
uncertainty in coefficient estimates for our primary predictors
variables, and hence gives greater statistical power to detect true
effects.</p>
<div class="section level3">
<h3 id="generate-some-simulated-data-with-covarirates">Generate some simulated data with covarirates<a class="anchor" aria-label="anchor" href="#generate-some-simulated-data-with-covarirates"></a>
</h3>
<p>First, we generate some simulated data with covariates. We will
generate 98 samples with 3 covariates, and then allocate these samples
to batches of 13.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toy_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span>n_samples <span class="op">=</span> <span class="fl">98</span>, block_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">toy_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   sample_id covariate1  covariate2 covariate3 block_id</span></span>
<span><span class="co">#&gt; 1   Sample1  0.2875775 -0.08336907          C  block_1</span></span>
<span><span class="co">#&gt; 2   Sample2  0.7883051  0.25331851          B  block_1</span></span>
<span><span class="co">#&gt; 3   Sample3  0.4089769 -0.02854676          B  block_2</span></span>
<span><span class="co">#&gt; 4   Sample4  0.8830174 -0.04287046          B  block_2</span></span>
<span><span class="co">#&gt; 5   Sample5  0.9404673  1.36860228          C  block_3</span></span>
<span><span class="co">#&gt; 6   Sample6  0.0455565 -0.22577099          A  block_3</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="randomisation">Randomisation<a class="anchor" aria-label="anchor" href="#randomisation"></a>
</h3>
<p>A common approach reported in the analysis of clinical samples is to
simply randomise samples to different batches. Randomisation is
frequently used in clinical trials to try to ensure that the treatment
groups are balanced with respect to relevant covariates. In this
circumstance, covariates for all patients are not known at the time when
treatments are allocated and so randomisation our best option to ensure
that the control and treatment groups are balanced with respect to these
covariates. In statistical terms, there is no bias: the expectation of
the value of any given covariates would be equal for both a control and
a treatment group: i.e. that if we repeated the experiment many times,
the average value of the covariate would be the same for both
groups.</p>
<p>We can simply generate a random layout of our toy dataset of 98
samples to a batch size of 13 as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">single_layout</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>,</span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>,</span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>                                 blocking_variable <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">single_layout</span><span class="op">$</span><span class="va">layout</span><span class="op">)</span></span>
<span><span class="co">#&gt;   covariate1  covariate2 covariate3 sample_id batch_allocation block_id</span></span>
<span><span class="co">#&gt; 1  0.2875775 -0.08336907          C   Sample1                7  block_1</span></span>
<span><span class="co">#&gt; 2  0.7883051  0.25331851          B   Sample2                7  block_1</span></span>
<span><span class="co">#&gt; 3  0.4089769 -0.02854676          B   Sample3                3  block_2</span></span>
<span><span class="co">#&gt; 4  0.8830174 -0.04287046          B   Sample4                6  block_2</span></span>
<span><span class="co">#&gt; 5  0.9404673  1.36860228          C   Sample5                3  block_3</span></span>
<span><span class="co">#&gt; 6  0.0455565 -0.22577099          A   Sample6                2  block_3</span></span></code></pre></div>
<p>The function <code>allocate_samples</code> returns a list with the
layout of samples to batches in the <code>layout</code> slot and the
probability that a covaraite does not differ between the batches
(appropriate for continuous or categorical variables depending upon the
input data type) in the <code>results</code> slot. With a given set of
samples, the sample size is fixed and thus calculating a
<em>p</em>-value for the difference in the covariate between the batches
is directly related to the underlying test statistic. The
<code>results</code> slot contains the <em>p</em>-value for the
difference in each covariate between the batches.</p>
<p>We can assess the balance of the layout across all of our specified
covariates by calculating a balance score (defined in the following
sections). This metric is in the range [0, 1], with higher values
indicating better balance.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calculate_balance_score.html">calculate_balance_score</a></span><span class="op">(</span><span class="va">single_layout</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.04197451</span></span></code></pre></div>
<p>Here we can see that the balance score of our layout is low
(indicative of imbalance), despite the fact that the layout was
generated randomly. This is because whilst randomisation ensures no
statistical bias, it does not remove the impact of chance, in that there
is still <em>variance</em> in the balance of the covariates between the
batches.</p>
<p>In order to demonstrate this empirically, we can generate a large
number of random layouts and examine the distribution of the balance
score. As can be seen in the documentation, the
<code><a href="../reference/allocate_samples.html">allocate_samples()</a></code> function includes a random seed for
reproducibility, and so here we explicitly set a series of different
random seeds.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">random_seeds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10000</span>, <span class="fl">1000</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">random_seeds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>,</span>
<span>                   batch_size <span class="op">=</span> <span class="fl">13</span>,</span>
<span>                   covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                   method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>                   blocking_variable <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                   seed <span class="op">=</span> <span class="va">seed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot histrogram for a single covariate: covariate1</span></span>
<span><span class="va">probability_covariate1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    iteration_number <span class="op">=</span> <span class="va">i</span>,</span>
<span>    p_value <span class="op">=</span> <span class="va">results_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">covariate</span> <span class="op">==</span> <span class="st">"covariate1"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">pull</span><span class="op">(</span><span class="va">p_value</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">plot_data_covariate1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">probability_covariate1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot histrogram of probability that covariate1 does not differ between the batches</span></span>
<span><span class="va">plot_data_covariate1</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.05</span>, boundary <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-6-1.png" width="672">
As expected given the lack of bias that randomisation guarantees, over
many iterations we observe a uniform distribution of the
<em>p</em>-value calcualted for a single variable. But note that within
this set of random layouts, there are still many layouts with a low
<em>p</em>-value: indicating that the covariate is not balanced between
the batches despite randomisation.</p>
<p>In order to simultaneously assess the balance of multiple covariates
between batches, we combine the <em>p</em>-values for all covariates
which are each calculated by the appropriate statistical test. For this
we used the established approach of calculating the harmonic mean of the
<em>p</em>-values, which has the advantage over alternative options in
that it does not require the restrictive assumption that covariates are
independent. The distribution of the balance score across these many
random layouts shows that there are few layouts with high score that
indicate they are well balanced across all covariates.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">balance_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    iteration_number <span class="op">=</span> <span class="va">i</span>,</span>
<span>    balance_score <span class="op">=</span> <span class="fu"><a href="../reference/calculate_balance_score.html">calculate_balance_score</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data_balance_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">balance_score</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot histrogram of balance scores</span></span>
<span><span class="va">plot_data_balance_score</span>  <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">balance_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.05</span>, boundary <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlim</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>The “brute force” approach of allocating samples to batches would
simply then select the best layout from these random layouts. This is
implemented in the <code>allocate_samples</code> function using the
<code>method = "best_random"</code> argument for demonstration purposes
(though note that due to the use of different random seeds, this layout
may differ from that we have generated above). Here, we generate 1000
random layouts and then select the one with the best balance of the
covariates.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_random_layout</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"best_random"</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98 </span></span>
<span><span class="co">#&gt; Balance Score: 0.9195397</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">best_random_layout</span><span class="op">$</span><span class="va">layout</span><span class="op">)</span></span>
<span><span class="co">#&gt;   covariate1  covariate2 covariate3 sample_id batch_allocation block_id</span></span>
<span><span class="co">#&gt; 1  0.2875775 -0.08336907          C   Sample1                2  block_1</span></span>
<span><span class="co">#&gt; 2  0.7883051  0.25331851          B   Sample2                5  block_1</span></span>
<span><span class="co">#&gt; 3  0.4089769 -0.02854676          B   Sample3                7  block_2</span></span>
<span><span class="co">#&gt; 4  0.8830174 -0.04287046          B   Sample4                3  block_2</span></span>
<span><span class="co">#&gt; 5  0.9404673  1.36860228          C   Sample5                3  block_3</span></span>
<span><span class="co">#&gt; 6  0.0455565 -0.22577099          A   Sample6                5  block_3</span></span></code></pre></div>
<p>We can see that the best random layout is clearly a superior layout
to the common practice of performing a single randomisation as we did
above. On the other side of the coin, there are still many possible
layouts that have superior balance.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calculate_balance_score.html">calculate_balance_score</a></span><span class="op">(</span><span class="va">best_random_layout</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9195397</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="optimisation-methods-from-machine-learning">Optimisation methods from machine learning<a class="anchor" aria-label="anchor" href="#optimisation-methods-from-machine-learning"></a>
</h3>
<p>Even with the processing capabilities of modern desktop computers,
brute force approaches such as applied above are problematic since the
number of possible combinations quickly explodes. Since exhaustive
search is therefore impractical, we exploit machine learning
optimisation approaches in order to maximise the balance of the batches
that are generated. Specifically we utilise a simulated annealing
algorithm, which is a heuristic optimisation method that can efficiently
approximate the global optimum of a large search space. Interested
readers are directed towards the general introduction from wikipedia
[wikipedia_2023a]. Practically, we implement the method here as the
default method using to allocate samples to different batches (but can
be explicitly specified using the argument
<code>method = "simulated_annealing"</code>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimal_layout</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 iterations <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                                 plot_convergence <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; Balance Score of final layout: 0.9987868</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span></code></pre>
<p>For clarity, we return a plot to make it easy for the user to confirm
that the simulated annealing algorithm has been run with a sufficient
number of iterations to converge, seen by the saturation of the balance
score.</p>
<p>Accordingly, we also achieve a more balanced configuration than that
of the best random layout.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calculate_balance_score.html">calculate_balance_score</a></span><span class="op">(</span><span class="va">optimal_layout</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9987868</span></span></code></pre></div>
<p>We can also compare the run time of the simulated annealing algorithm
to that of the best random layout.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rerun best_random_layout to calculate run time</span></span>
<span><span class="va">runtime_brute_force</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">best_random_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                         batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                         covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                         iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                         method <span class="op">=</span> <span class="st">"best_random"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98 </span></span>
<span><span class="co">#&gt; Balance Score: 0.9195397</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="co"># rerun optimal_layout to calculate run time</span></span>
<span><span class="va">runtime_optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">optimal_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                     batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                     covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                     method <span class="op">=</span> <span class="st">"simulated_annealing"</span>,</span>
<span>                                     iterations <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; Balance Score of final layout: 0.9987868</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="co"># plot run times</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"brute_force"</span>, <span class="st">"simulated_annealing"</span><span class="op">)</span>,</span>
<span>           time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">runtime_brute_force</span>, <span class="va">runtime_optimal</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">time</span>, fill <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-12-2.png" width="672">
In addition to generating a more balanced layout, we see that the
machine learning approach also achieves this with fewer iterations and
in less run time.</p>
</div>
<div class="section level3">
<h3 id="blocking">Blocking<a class="anchor" aria-label="anchor" href="#blocking"></a>
</h3>
<p>There is a adage on the design of experiments, commonly attributed to
George Box, to “block what you can, randomise what you cannot”. We have
discussed the limitations of randomisation in situations where the
covariates for all samples are already known in advance. However, the
advice to block variables is still pertinent in our situation, as
blocking will completely remove the impact of the technical batch effect
upon a blocked predictor variable rather than only mitigate against it.
We also implement functionality to block samples within batches by a
specified variable as follows:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimal_layout_blocked</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 blocking_variable <span class="op">=</span> <span class="st">"block_id"</span>,</span>
<span>                                 iterations <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"simulated_annealing"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Blocking variable:  block_id </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; Balance Score of final layout: 0.9976422</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3, block_id,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="plot-an-overview-of-the-layout">plot an overview of the layout<a class="anchor" aria-label="anchor" href="#plot-an-overview-of-the-layout"></a>
</h3>
<p>In order to easily get an overview of the balance of a particular
layout (a useful sanity check!), we provide a simple function to plot
the levels of covariates across the batches.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_layout.html">plot_layout</a></span><span class="op">(</span><span class="va">optimal_layout_blocked</span>, covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $continuous</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $categorical</span></span></code></pre>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-14-2.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="session-info">session info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.1 (2025-06-13)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.2 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] ggplot2_3.5.2         dplyr_1.1.4           SampleAllocateR_1.0.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] gtable_0.3.6       jsonlite_2.0.0     compiler_4.5.1     tidyselect_1.2.1  </span></span>
<span><span class="co">#&gt;  [5] tidyr_1.3.1        jquerylib_0.1.4    systemfonts_1.2.3  scales_1.4.0      </span></span>
<span><span class="co">#&gt;  [9] textshaping_1.0.1  yaml_2.3.10        fastmap_1.2.0      R6_2.6.1          </span></span>
<span><span class="co">#&gt; [13] labeling_0.4.3     generics_0.1.4     knitr_1.50         tibble_3.3.0      </span></span>
<span><span class="co">#&gt; [17] desc_1.4.3         bslib_0.9.0        pillar_1.11.0      RColorBrewer_1.1-3</span></span>
<span><span class="co">#&gt; [21] rlang_1.1.6        cachem_1.1.0       xfun_0.52          fs_1.6.6          </span></span>
<span><span class="co">#&gt; [25] sass_0.4.10        cli_3.6.5          withr_3.0.2        pkgdown_2.1.3     </span></span>
<span><span class="co">#&gt; [29] magrittr_2.0.3     digest_0.6.37      grid_4.5.1         lifecycle_1.0.4   </span></span>
<span><span class="co">#&gt; [33] vctrs_0.6.5        evaluate_1.0.4     glue_1.8.0         farver_2.1.2      </span></span>
<span><span class="co">#&gt; [37] ragg_1.4.0         rmarkdown_2.29     purrr_1.1.0        tools_4.5.1       </span></span>
<span><span class="co">#&gt; [41] pkgconfig_2.0.3    htmltools_0.5.8.1</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Mulvey.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
