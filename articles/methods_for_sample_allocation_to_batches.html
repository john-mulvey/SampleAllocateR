<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>methods_for_sample_allocation_to_batches • SampleAllocateR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="methods_for_sample_allocation_to_batches">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SampleAllocateR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/methods_for_sample_allocation_to_batches.html">methods_for_sample_allocation_to_batches</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>methods_for_sample_allocation_to_batches</h1>
            
      

      <div class="d-none name"><code>methods_for_sample_allocation_to_batches.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="packages">packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h2>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Especially as the costs of performing assays has decreased, there has
been a move from analysing few samples from carefully controlled
experiments to analysing samples directly from patient population of
interest. Controlled experiments are performed in experimental model
systems in order that covariates can be held constant across all
experimental units, whereas in clinical samples there will commonly be
number of covariates that also impact upon the dependent variable of
interest. Performing assays on a large number of samples requires that
the be analysed in <em>batches</em>, which results in technical
variation that should be accounted for in the analysis. Here we
demonstrate a tool to allocate pre-selectedsamples to these technical
batches in a way that maximises the balance of specified covariates. By
maximising our ability to estimate the effects of the batch and the
specified covaraites, this facilitates best estimation of the effect of
the dependent variable of interest.</p>
<div class="section level3">
<h3 id="generate-some-simulated-data-with-covarirates">Generate some simulated data with covarirates<a class="anchor" aria-label="anchor" href="#generate-some-simulated-data-with-covarirates"></a>
</h3>
<p>First, we generate some simulated data with covariates. We will
generate 98 samples with 3 covariates, and then allocate these samples
to batches of 13.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toy_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span>n_samples <span class="op">=</span> <span class="fl">98</span>, block_size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">toy_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   sample_id covariate1  covariate2 covariate3 block_id</span></span>
<span><span class="co">#&gt; 1   Sample1  0.2875775 -0.08336907          C  block_1</span></span>
<span><span class="co">#&gt; 2   Sample2  0.7883051  0.25331851          B  block_1</span></span>
<span><span class="co">#&gt; 3   Sample3  0.4089769 -0.02854676          B  block_2</span></span>
<span><span class="co">#&gt; 4   Sample4  0.8830174 -0.04287046          B  block_2</span></span>
<span><span class="co">#&gt; 5   Sample5  0.9404673  1.36860228          C  block_3</span></span>
<span><span class="co">#&gt; 6   Sample6  0.0455565 -0.22577099          A  block_3</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="randomisation">Randomisation<a class="anchor" aria-label="anchor" href="#randomisation"></a>
</h3>
<p>A common approach reported in the analysis of clinical samples is to
simply randomise samples to different batches. Randomisation is
frequently used in clinical trials to ensure that the treatment groups
are balanced with respect to known and unknown covariates. In this
circumstance, covariates for all patients are not known at the time when
treatments are allocated and so is our best chance to ensure that the
treatment groups are balanced with respect to these covariates. In
statistical terms, there is no bias: the expectation of the value of any
given covariates would be equal for both a control and a treatment
group: i.e. that if we repeated the experiment many times, the average
value of the covariate would be the same for both groups.</p>
<p>We can simply generate a single random layout of our toy dataset of
98 samples to a batch size of 13 as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">single_layout</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>,</span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>,</span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>                                 blocking_variable <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">single_layout</span><span class="op">)</span></span>
<span><span class="co">#&gt; $layout</span></span>
<span><span class="co">#&gt;       covariate1   covariate2 covariate3 sample_id batch_allocation block_id</span></span>
<span><span class="co">#&gt; 1   0.2875775201 -0.083369066          C   Sample1                7  block_1</span></span>
<span><span class="co">#&gt; 2   0.7883051354  0.253318514          B   Sample2                7  block_1</span></span>
<span><span class="co">#&gt; 3   0.4089769218 -0.028546755          B   Sample3                3  block_2</span></span>
<span><span class="co">#&gt; 4   0.8830174040 -0.042870457          B   Sample4                6  block_2</span></span>
<span><span class="co">#&gt; 5   0.9404672843  1.368602284          C   Sample5                3  block_3</span></span>
<span><span class="co">#&gt; 6   0.0455564994 -0.225770986          A   Sample6                2  block_3</span></span>
<span><span class="co">#&gt; 7   0.5281054880  1.516470604          B   Sample7                2  block_4</span></span>
<span><span class="co">#&gt; 8   0.8924190444 -1.548752804          B   Sample8                3  block_4</span></span>
<span><span class="co">#&gt; 9   0.5514350145  0.584613750          A   Sample9                5  block_5</span></span>
<span><span class="co">#&gt; 10  0.4566147353  0.123854244          B  Sample10                1  block_5</span></span>
<span><span class="co">#&gt; 11  0.9568333453  0.215941569          A  Sample11                2  block_6</span></span>
<span><span class="co">#&gt; 12  0.4533341562  0.379639483          A  Sample12                3  block_6</span></span>
<span><span class="co">#&gt; 13  0.6775706355 -0.502323453          B  Sample13                5  block_7</span></span>
<span><span class="co">#&gt; 14  0.5726334020 -0.333207384          C  Sample14                5  block_7</span></span>
<span><span class="co">#&gt; 15  0.1029246827 -1.018575383          A  Sample15                1  block_8</span></span>
<span><span class="co">#&gt; 16  0.8998249704 -1.071791226          C  Sample16                1  block_8</span></span>
<span><span class="co">#&gt; 17  0.2460877344  0.303528641          A  Sample17                8  block_9</span></span>
<span><span class="co">#&gt; 18  0.0420595335  0.448209779          B  Sample18                2  block_9</span></span>
<span><span class="co">#&gt; 19  0.3279207193  0.053004227          A  Sample19                7 block_10</span></span>
<span><span class="co">#&gt; 20  0.9545036491  0.922267468          B  Sample20                3 block_10</span></span>
<span><span class="co">#&gt; 21  0.8895393161  2.050084686          B  Sample21                1 block_11</span></span>
<span><span class="co">#&gt; 22  0.6928034062 -0.491031166          B  Sample22                3 block_11</span></span>
<span><span class="co">#&gt; 23  0.6405068138 -2.309168876          C  Sample23                4 block_12</span></span>
<span><span class="co">#&gt; 24  0.9942697766  1.005738524          A  Sample24                6 block_12</span></span>
<span><span class="co">#&gt; 25  0.6557057991 -0.709200763          A  Sample25                1 block_13</span></span>
<span><span class="co">#&gt; 26  0.7085304682 -0.688008616          A  Sample26                4 block_13</span></span>
<span><span class="co">#&gt; 27  0.5440660247  1.025571370          A  Sample27                7 block_14</span></span>
<span><span class="co">#&gt; 28  0.5941420204 -0.284773007          C  Sample28                8 block_14</span></span>
<span><span class="co">#&gt; 29  0.2891597373 -1.220717712          A  Sample29                6 block_15</span></span>
<span><span class="co">#&gt; 30  0.1471136473  0.181303480          B  Sample30                4 block_15</span></span>
<span><span class="co">#&gt; 31  0.9630242325 -0.138891362          A  Sample31                1 block_16</span></span>
<span><span class="co">#&gt; 32  0.9022990451  0.005764186          B  Sample32                7 block_16</span></span>
<span><span class="co">#&gt; 33  0.6907052784  0.385280401          B  Sample33                3 block_17</span></span>
<span><span class="co">#&gt; 34  0.7954674177 -0.370660032          A  Sample34                4 block_17</span></span>
<span><span class="co">#&gt; 35  0.0246136845  0.644376549          A  Sample35                5 block_18</span></span>
<span><span class="co">#&gt; 36  0.4777959711 -0.220486562          A  Sample36                7 block_18</span></span>
<span><span class="co">#&gt; 37  0.7584595375  0.331781964          A  Sample37                6 block_19</span></span>
<span><span class="co">#&gt; 38  0.2164079358  1.096839013          C  Sample38                8 block_19</span></span>
<span><span class="co">#&gt; 39  0.3181810076  0.435181491          A  Sample39                6 block_20</span></span>
<span><span class="co">#&gt; 40  0.2316257854 -0.325931586          A  Sample40                2 block_20</span></span>
<span><span class="co">#&gt; 41  0.1428000224  1.148807618          A  Sample41                5 block_21</span></span>
<span><span class="co">#&gt; 42  0.4145463358  0.993503856          B  Sample42                5 block_21</span></span>
<span><span class="co">#&gt; 43  0.4137243263  0.548396960          B  Sample43                8 block_22</span></span>
<span><span class="co">#&gt; 44  0.3688454509  0.238731735          C  Sample44                4 block_22</span></span>
<span><span class="co">#&gt; 45  0.1524447477 -0.627906076          B  Sample45                5 block_23</span></span>
<span><span class="co">#&gt; 46  0.1388060634  1.360652449          C  Sample46                2 block_23</span></span>
<span><span class="co">#&gt; 47  0.2330340995 -0.600259587          A  Sample47                1 block_24</span></span>
<span><span class="co">#&gt; 48  0.4659624503  2.187332993          A  Sample48                6 block_24</span></span>
<span><span class="co">#&gt; 49  0.2659726404  1.532610626          A  Sample49                4 block_25</span></span>
<span><span class="co">#&gt; 50  0.8578277153 -0.235700359          A  Sample50                7 block_25</span></span>
<span><span class="co">#&gt; 51  0.0458311667 -1.026420900          A  Sample51                2 block_26</span></span>
<span><span class="co">#&gt; 52  0.4422000742 -0.710406564          C  Sample52                5 block_26</span></span>
<span><span class="co">#&gt; 53  0.7989248456  0.256883709          A  Sample53                1 block_27</span></span>
<span><span class="co">#&gt; 54  0.1218992600 -0.246691878          A  Sample54                2 block_27</span></span>
<span><span class="co">#&gt; 55  0.5609479838 -0.347542599          C  Sample55                7 block_28</span></span>
<span><span class="co">#&gt; 56  0.2065313896 -0.951618567          C  Sample56                7 block_28</span></span>
<span><span class="co">#&gt; 57  0.1275316502 -0.045027725          B  Sample57                8 block_29</span></span>
<span><span class="co">#&gt; 58  0.7533078643 -0.784904469          A  Sample58                8 block_29</span></span>
<span><span class="co">#&gt; 59  0.8950453592 -1.667941937          A  Sample59                6 block_30</span></span>
<span><span class="co">#&gt; 60  0.3744627759 -0.380226520          A  Sample60                6 block_30</span></span>
<span><span class="co">#&gt; 61  0.6651151946  0.918996609          B  Sample61                8 block_31</span></span>
<span><span class="co">#&gt; 62  0.0948406609 -0.575346963          A  Sample62                6 block_31</span></span>
<span><span class="co">#&gt; 63  0.3839696378  0.607964322          B  Sample63                6 block_32</span></span>
<span><span class="co">#&gt; 64  0.2743836446 -1.617882708          A  Sample64                5 block_32</span></span>
<span><span class="co">#&gt; 65  0.8146400389 -0.055561966          A  Sample65                7 block_33</span></span>
<span><span class="co">#&gt; 66  0.4485163414  0.519407204          C  Sample66                8 block_33</span></span>
<span><span class="co">#&gt; 67  0.8100643530  0.301153362          C  Sample67                1 block_34</span></span>
<span><span class="co">#&gt; 68  0.8123895095  0.105676194          B  Sample68                1 block_34</span></span>
<span><span class="co">#&gt; 69  0.7943423211 -0.640706008          B  Sample69                4 block_35</span></span>
<span><span class="co">#&gt; 70  0.4398316876 -0.849704346          A  Sample70                7 block_35</span></span>
<span><span class="co">#&gt; 71  0.7544751586 -1.024128791          C  Sample71                7 block_36</span></span>
<span><span class="co">#&gt; 72  0.6292211316  0.117646597          A  Sample72                7 block_36</span></span>
<span><span class="co">#&gt; 73  0.7101824014 -0.947474614          A  Sample73                4 block_37</span></span>
<span><span class="co">#&gt; 74  0.0006247733 -0.490557444          B  Sample74                6 block_37</span></span>
<span><span class="co">#&gt; 75  0.4753165741 -0.256092192          A  Sample75                2 block_38</span></span>
<span><span class="co">#&gt; 76  0.2201188852  1.843862005          B  Sample76                8 block_38</span></span>
<span><span class="co">#&gt; 77  0.3798165377 -0.651949902          B  Sample77                6 block_39</span></span>
<span><span class="co">#&gt; 78  0.6127710033  0.235386572          B  Sample78                1 block_39</span></span>
<span><span class="co">#&gt; 79  0.3517979092  0.077960850          B  Sample79                3 block_40</span></span>
<span><span class="co">#&gt; 80  0.1111354243 -0.961856634          C  Sample80                4 block_40</span></span>
<span><span class="co">#&gt; 81  0.2436194727 -0.071308086          C  Sample81                2 block_41</span></span>
<span><span class="co">#&gt; 82  0.6680555874  1.444550858          C  Sample82                5 block_41</span></span>
<span><span class="co">#&gt; 83  0.4176467797  0.451504053          C  Sample83                8 block_42</span></span>
<span><span class="co">#&gt; 84  0.7881958340  0.041232922          A  Sample84                1 block_42</span></span>
<span><span class="co">#&gt; 85  0.1028646443 -0.422496832          C  Sample85                8 block_43</span></span>
<span><span class="co">#&gt; 86  0.4348927415 -2.053247222          C  Sample86                4 block_43</span></span>
<span><span class="co">#&gt; 87  0.9849569800  1.131337213          C  Sample87                4 block_44</span></span>
<span><span class="co">#&gt; 88  0.8930511144 -1.460640071          B  Sample88                4 block_44</span></span>
<span><span class="co">#&gt; 89  0.8864690608  0.739947511          C  Sample89                5 block_45</span></span>
<span><span class="co">#&gt; 90  0.1750526503  1.909103569          C  Sample90                8 block_45</span></span>
<span><span class="co">#&gt; 91  0.1306956916 -1.443893161          C  Sample91                4 block_46</span></span>
<span><span class="co">#&gt; 92  0.6531019250  0.701784335          A  Sample92                3 block_46</span></span>
<span><span class="co">#&gt; 93  0.3435164723 -0.262197489          A  Sample93                2 block_47</span></span>
<span><span class="co">#&gt; 94  0.6567581280 -1.572144159          C  Sample94                2 block_47</span></span>
<span><span class="co">#&gt; 95  0.3203732425 -1.514667654          B  Sample95                8 block_48</span></span>
<span><span class="co">#&gt; 96  0.1876911193 -1.601536174          C  Sample96                3 block_48</span></span>
<span><span class="co">#&gt; 97  0.7822943013 -0.530906522          B  Sample97                3 block_49</span></span>
<span><span class="co">#&gt; 98  0.0935949867 -1.461755585          A  Sample98                5 block_49</span></span>
<span><span class="co">#&gt; 99            NA           NA       &lt;NA&gt;  padding1                2     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 100           NA           NA       &lt;NA&gt;  padding2                3     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 101           NA           NA       &lt;NA&gt;  padding3                5     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 102           NA           NA       &lt;NA&gt;  padding4                1     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 103           NA           NA       &lt;NA&gt;  padding5                6     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 104           NA           NA       &lt;NA&gt;  padding6                3     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;   covariate  p_value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> covariate1  0.017<span style="text-decoration: underline;">5</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> covariate2  0.484 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> covariate3  0.082<span style="text-decoration: underline;">0</span></span></span></code></pre></div>
<p>The function <code>allocate_samples</code> returns a list with the
layout of samples to batches in the <code>layout</code> slot and the
probability that a covaraite does not differ between the batches
(appropriate for continuous or categorical variables depending upon the
input data type) in the <code>results</code> slot.</p>
<p>We can assess the balance of the layout across all of our specified
covariates by calculating the joint probability that all of them do not
differ between the batches. Since probabilities are multiplicative, we
calcluate this simply at the product of the individual probabilities
that each covariate does not differ between the batches.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">single_layout</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.0006938787</span></span></code></pre></div>
<p>Here we can see that the joint probability that all of the covariates
do not differ between the batches is low, despite the fact that the
layout was generated randomly.</p>
<p>In order to get an overview of how good a single random layout is, we
can generate a large number of random layouts and examine the
distribution of the joint probability that all of the covariates do not
differ between the batches. As can be seen in the documentation, the
<code><a href="../reference/allocate_samples.html">allocate_samples()</a></code> function inculdes a random seed for
reproducibility, and so here we explicitly set a series of different
random seeds.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">random_seeds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10000</span>, <span class="fl">1000</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">random_seeds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>,</span>
<span>                   batch_size <span class="op">=</span> <span class="fl">13</span>,</span>
<span>                   covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                   method <span class="op">=</span> <span class="st">"random"</span>,</span>
<span>                   blocking_variable <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                   seed <span class="op">=</span> <span class="va">seed</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot histrogram for a single covariate: covariate1</span></span>
<span><span class="va">probability_covariate1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">results_list</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    iteration_number <span class="op">=</span> <span class="va">i</span>,</span>
<span>    p_value <span class="op">=</span> <span class="va">results_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">covariate</span> <span class="op">==</span> <span class="st">"covariate1"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">pull</span><span class="op">(</span><span class="va">p_value</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">plot_data_covariate1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">probability_covariate1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot histrogram of probability that covariate1 does not differ between the batches</span></span>
<span><span class="va">plot_data_covariate1</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">p_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-6-1.png" width="672">
As expected, we observe a uniform distribution for a single varaible -
but note that are still many layouts with a low probability that the
covariate does not differ between the batches.</p>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>The “brute force” approach to allocating samples to batches would
simply then select the best layout from these random layouts. This is
implemented in the <code>allocate_samples</code> function using the
<code>method = "best_random"</code> argument for demonstration purposes
(though note that due to the use of different random seeds, this layout
may differ from that generated above). Here, we generate 1000 random
layouts and then select the one with the best balance of the
covariates.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">best_random_layout</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"best_random"</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98 </span></span>
<span><span class="co">#&gt; Joint probability that the best layout is balanced: 0.7795554</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">best_random_layout</span><span class="op">)</span></span>
<span><span class="co">#&gt; $layout</span></span>
<span><span class="co">#&gt;       covariate1   covariate2 covariate3 sample_id batch_allocation block_id</span></span>
<span><span class="co">#&gt; 1   0.2875775201 -0.083369066          C   Sample1                2  block_1</span></span>
<span><span class="co">#&gt; 2   0.7883051354  0.253318514          B   Sample2                5  block_1</span></span>
<span><span class="co">#&gt; 3   0.4089769218 -0.028546755          B   Sample3                7  block_2</span></span>
<span><span class="co">#&gt; 4   0.8830174040 -0.042870457          B   Sample4                3  block_2</span></span>
<span><span class="co">#&gt; 5   0.9404672843  1.368602284          C   Sample5                3  block_3</span></span>
<span><span class="co">#&gt; 6   0.0455564994 -0.225770986          A   Sample6                5  block_3</span></span>
<span><span class="co">#&gt; 7   0.5281054880  1.516470604          B   Sample7                2  block_4</span></span>
<span><span class="co">#&gt; 8   0.8924190444 -1.548752804          B   Sample8                6  block_4</span></span>
<span><span class="co">#&gt; 9   0.5514350145  0.584613750          A   Sample9                6  block_5</span></span>
<span><span class="co">#&gt; 10  0.4566147353  0.123854244          B  Sample10                2  block_5</span></span>
<span><span class="co">#&gt; 11  0.9568333453  0.215941569          A  Sample11                8  block_6</span></span>
<span><span class="co">#&gt; 12  0.4533341562  0.379639483          A  Sample12                5  block_6</span></span>
<span><span class="co">#&gt; 13  0.6775706355 -0.502323453          B  Sample13                3  block_7</span></span>
<span><span class="co">#&gt; 14  0.5726334020 -0.333207384          C  Sample14                3  block_7</span></span>
<span><span class="co">#&gt; 15  0.1029246827 -1.018575383          A  Sample15                6  block_8</span></span>
<span><span class="co">#&gt; 16  0.8998249704 -1.071791226          C  Sample16                5  block_8</span></span>
<span><span class="co">#&gt; 17  0.2460877344  0.303528641          A  Sample17                6  block_9</span></span>
<span><span class="co">#&gt; 18  0.0420595335  0.448209779          B  Sample18                4  block_9</span></span>
<span><span class="co">#&gt; 19  0.3279207193  0.053004227          A  Sample19                3 block_10</span></span>
<span><span class="co">#&gt; 20  0.9545036491  0.922267468          B  Sample20                5 block_10</span></span>
<span><span class="co">#&gt; 21  0.8895393161  2.050084686          B  Sample21                4 block_11</span></span>
<span><span class="co">#&gt; 22  0.6928034062 -0.491031166          B  Sample22                5 block_11</span></span>
<span><span class="co">#&gt; 23  0.6405068138 -2.309168876          C  Sample23                7 block_12</span></span>
<span><span class="co">#&gt; 24  0.9942697766  1.005738524          A  Sample24                7 block_12</span></span>
<span><span class="co">#&gt; 25  0.6557057991 -0.709200763          A  Sample25                1 block_13</span></span>
<span><span class="co">#&gt; 26  0.7085304682 -0.688008616          A  Sample26                4 block_13</span></span>
<span><span class="co">#&gt; 27  0.5440660247  1.025571370          A  Sample27                1 block_14</span></span>
<span><span class="co">#&gt; 28  0.5941420204 -0.284773007          C  Sample28                1 block_14</span></span>
<span><span class="co">#&gt; 29  0.2891597373 -1.220717712          A  Sample29                2 block_15</span></span>
<span><span class="co">#&gt; 30  0.1471136473  0.181303480          B  Sample30                1 block_15</span></span>
<span><span class="co">#&gt; 31  0.9630242325 -0.138891362          A  Sample31                1 block_16</span></span>
<span><span class="co">#&gt; 32  0.9022990451  0.005764186          B  Sample32                5 block_16</span></span>
<span><span class="co">#&gt; 33  0.6907052784  0.385280401          B  Sample33                4 block_17</span></span>
<span><span class="co">#&gt; 34  0.7954674177 -0.370660032          A  Sample34                2 block_17</span></span>
<span><span class="co">#&gt; 35  0.0246136845  0.644376549          A  Sample35                2 block_18</span></span>
<span><span class="co">#&gt; 36  0.4777959711 -0.220486562          A  Sample36                1 block_18</span></span>
<span><span class="co">#&gt; 37  0.7584595375  0.331781964          A  Sample37                7 block_19</span></span>
<span><span class="co">#&gt; 38  0.2164079358  1.096839013          C  Sample38                3 block_19</span></span>
<span><span class="co">#&gt; 39  0.3181810076  0.435181491          A  Sample39                4 block_20</span></span>
<span><span class="co">#&gt; 40  0.2316257854 -0.325931586          A  Sample40                8 block_20</span></span>
<span><span class="co">#&gt; 41  0.1428000224  1.148807618          A  Sample41                5 block_21</span></span>
<span><span class="co">#&gt; 42  0.4145463358  0.993503856          B  Sample42                1 block_21</span></span>
<span><span class="co">#&gt; 43  0.4137243263  0.548396960          B  Sample43                8 block_22</span></span>
<span><span class="co">#&gt; 44  0.3688454509  0.238731735          C  Sample44                4 block_22</span></span>
<span><span class="co">#&gt; 45  0.1524447477 -0.627906076          B  Sample45                4 block_23</span></span>
<span><span class="co">#&gt; 46  0.1388060634  1.360652449          C  Sample46                5 block_23</span></span>
<span><span class="co">#&gt; 47  0.2330340995 -0.600259587          A  Sample47                3 block_24</span></span>
<span><span class="co">#&gt; 48  0.4659624503  2.187332993          A  Sample48                8 block_24</span></span>
<span><span class="co">#&gt; 49  0.2659726404  1.532610626          A  Sample49                1 block_25</span></span>
<span><span class="co">#&gt; 50  0.8578277153 -0.235700359          A  Sample50                1 block_25</span></span>
<span><span class="co">#&gt; 51  0.0458311667 -1.026420900          A  Sample51                4 block_26</span></span>
<span><span class="co">#&gt; 52  0.4422000742 -0.710406564          C  Sample52                5 block_26</span></span>
<span><span class="co">#&gt; 53  0.7989248456  0.256883709          A  Sample53                8 block_27</span></span>
<span><span class="co">#&gt; 54  0.1218992600 -0.246691878          A  Sample54                5 block_27</span></span>
<span><span class="co">#&gt; 55  0.5609479838 -0.347542599          C  Sample55                6 block_28</span></span>
<span><span class="co">#&gt; 56  0.2065313896 -0.951618567          C  Sample56                5 block_28</span></span>
<span><span class="co">#&gt; 57  0.1275316502 -0.045027725          B  Sample57                3 block_29</span></span>
<span><span class="co">#&gt; 58  0.7533078643 -0.784904469          A  Sample58                7 block_29</span></span>
<span><span class="co">#&gt; 59  0.8950453592 -1.667941937          A  Sample59                2 block_30</span></span>
<span><span class="co">#&gt; 60  0.3744627759 -0.380226520          A  Sample60                7 block_30</span></span>
<span><span class="co">#&gt; 61  0.6651151946  0.918996609          B  Sample61                3 block_31</span></span>
<span><span class="co">#&gt; 62  0.0948406609 -0.575346963          A  Sample62                1 block_31</span></span>
<span><span class="co">#&gt; 63  0.3839696378  0.607964322          B  Sample63                2 block_32</span></span>
<span><span class="co">#&gt; 64  0.2743836446 -1.617882708          A  Sample64                4 block_32</span></span>
<span><span class="co">#&gt; 65  0.8146400389 -0.055561966          A  Sample65                3 block_33</span></span>
<span><span class="co">#&gt; 66  0.4485163414  0.519407204          C  Sample66                7 block_33</span></span>
<span><span class="co">#&gt; 67  0.8100643530  0.301153362          C  Sample67                7 block_34</span></span>
<span><span class="co">#&gt; 68  0.8123895095  0.105676194          B  Sample68                3 block_34</span></span>
<span><span class="co">#&gt; 69  0.7943423211 -0.640706008          B  Sample69                4 block_35</span></span>
<span><span class="co">#&gt; 70  0.4398316876 -0.849704346          A  Sample70                6 block_35</span></span>
<span><span class="co">#&gt; 71  0.7544751586 -1.024128791          C  Sample71                4 block_36</span></span>
<span><span class="co">#&gt; 72  0.6292211316  0.117646597          A  Sample72                2 block_36</span></span>
<span><span class="co">#&gt; 73  0.7101824014 -0.947474614          A  Sample73                4 block_37</span></span>
<span><span class="co">#&gt; 74  0.0006247733 -0.490557444          B  Sample74                6 block_37</span></span>
<span><span class="co">#&gt; 75  0.4753165741 -0.256092192          A  Sample75                8 block_38</span></span>
<span><span class="co">#&gt; 76  0.2201188852  1.843862005          B  Sample76                8 block_38</span></span>
<span><span class="co">#&gt; 77  0.3798165377 -0.651949902          B  Sample77                8 block_39</span></span>
<span><span class="co">#&gt; 78  0.6127710033  0.235386572          B  Sample78                6 block_39</span></span>
<span><span class="co">#&gt; 79  0.3517979092  0.077960850          B  Sample79                7 block_40</span></span>
<span><span class="co">#&gt; 80  0.1111354243 -0.961856634          C  Sample80                6 block_40</span></span>
<span><span class="co">#&gt; 81  0.2436194727 -0.071308086          C  Sample81                8 block_41</span></span>
<span><span class="co">#&gt; 82  0.6680555874  1.444550858          C  Sample82                8 block_41</span></span>
<span><span class="co">#&gt; 83  0.4176467797  0.451504053          C  Sample83                5 block_42</span></span>
<span><span class="co">#&gt; 84  0.7881958340  0.041232922          A  Sample84                2 block_42</span></span>
<span><span class="co">#&gt; 85  0.1028646443 -0.422496832          C  Sample85                1 block_43</span></span>
<span><span class="co">#&gt; 86  0.4348927415 -2.053247222          C  Sample86                1 block_43</span></span>
<span><span class="co">#&gt; 87  0.9849569800  1.131337213          C  Sample87                4 block_44</span></span>
<span><span class="co">#&gt; 88  0.8930511144 -1.460640071          B  Sample88                8 block_44</span></span>
<span><span class="co">#&gt; 89  0.8864690608  0.739947511          C  Sample89                6 block_45</span></span>
<span><span class="co">#&gt; 90  0.1750526503  1.909103569          C  Sample90                7 block_45</span></span>
<span><span class="co">#&gt; 91  0.1306956916 -1.443893161          C  Sample91                2 block_46</span></span>
<span><span class="co">#&gt; 92  0.6531019250  0.701784335          A  Sample92                7 block_46</span></span>
<span><span class="co">#&gt; 93  0.3435164723 -0.262197489          A  Sample93                1 block_47</span></span>
<span><span class="co">#&gt; 94  0.6567581280 -1.572144159          C  Sample94                8 block_47</span></span>
<span><span class="co">#&gt; 95  0.3203732425 -1.514667654          B  Sample95                6 block_48</span></span>
<span><span class="co">#&gt; 96  0.1876911193 -1.601536174          C  Sample96                8 block_48</span></span>
<span><span class="co">#&gt; 97  0.7822943013 -0.530906522          B  Sample97                3 block_49</span></span>
<span><span class="co">#&gt; 98  0.0935949867 -1.461755585          A  Sample98                3 block_49</span></span>
<span><span class="co">#&gt; 99            NA           NA       &lt;NA&gt;  padding1                6     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 100           NA           NA       &lt;NA&gt;  padding2                2     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 101           NA           NA       &lt;NA&gt;  padding3                7     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 102           NA           NA       &lt;NA&gt;  padding4                2     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 103           NA           NA       &lt;NA&gt;  padding5                6     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 104           NA           NA       &lt;NA&gt;  padding6                7     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $results</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">#&gt;   covariate  p_value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> covariate1   0.945</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> covariate2   0.868</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> covariate3   0.951</span></span></code></pre></div>
<p>Again, the balance of the layout across all of our specified
covariates is assessed calculating the joint probability that all of
them do not differ between the batches. We can see that the best random
layout is clearly a superior layout to the common practice of performing
a single randomisation as we did above.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">best_random_layout</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.7795554</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="optimisation-methods-from-machine-learning">Optimisation methods from machine learning<a class="anchor" aria-label="anchor" href="#optimisation-methods-from-machine-learning"></a>
</h3>
<p>Even with the processing capabilities of modern desktop computers,
brute force approaches are problematic since the number of possible
combinations quickly explodes.</p>
<!-- If we take our example of 98 samples and a batch size of 13, we can calculate the total number of possible allocations using the binomial coefficient as follows: -->
<!-- ```{r} -->
<!-- n_samples <- 98 -->
<!-- batch_size <- 13 -->
<!-- n_batches <- ceiling(n_samples / batch_size) -->
<!-- # Calculate the total number of possible allocations -->
<!-- n_possible_allocations <- 1 -->
<!-- for (batch in 1:n_batches) { -->
<!--   remaining_samples <- n_samples - (batch - 1) * batch_size -->
<!--   # For the last batch, adjust the batch size if fewer samples remain -->
<!--   current_batch_size <- min(batch_size, remaining_samples) -->
<!--   n_possible_allocations <- n_possible_allocations * choose(remaining_samples, current_batch_size) -->
<!-- } -->
<!-- n_possible_allocations -->
<!-- ``` -->
<!-- ??Factorial dependence on both the number of samples and the batch size, and exponential dependence on the number of batches. The number of possible allocations quickly exceeds not only the estimated number of atoms in the universe, but also the maximum value we can store in double precision floating point (with a batch size of 13, only 240 samples). -->
<p>Since exhaustive search is clearly impractical, we therefore we
exploit machine learning optimisation approaches in order to maximise
the balance of the batches that are generated. Specifically we utilise a
simulated annealing algorithm, which is a heuristic optimisation method
that can efficiently approximate the global optimum of a large search
space. Interested readers are directed towards the general introduction
from wikipedia [wikipedia_2023a], but in practice the method is
implemented as the default method using to allocate samples to different
batches (but can be explicitly specified using the argument
<code>method = "simulated_annealing"</code>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimal_layout</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 iterations <span class="op">=</span> <span class="fl">300</span>,</span>
<span>                                 plot_convergence <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; Joint probability that the final layout is balanced: 0.9970577</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span></code></pre>
<p>For clarity, we return a plot to make it easy for the user to confirm
that the simulated annealing algorithm has been run with a sufficient
number of iterations to converge, seen by the ???saturation of the joint
probability.</p>
<p>Accordingly, we also achieve a more balanced configuration than that
of the best random layout and within a samller number of iterations.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">optimal_layout</span><span class="op">[[</span><span class="st">'results'</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9960607</span></span></code></pre></div>
<p>We can also compare the run time of the simulated annealing algorithm
to that of the best random layout.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rerun best_random_layout to calculate run time</span></span>
<span><span class="va">runtime_brute_force</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">best_random_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                         batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                         covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                         iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                         method <span class="op">=</span> <span class="st">"best_random"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98 </span></span>
<span><span class="co">#&gt; Joint probability that the best layout is balanced: 0.7795554</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="co"># rerun optimal_layout to calculate run time</span></span>
<span><span class="va">runtime_optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">optimal_layout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                     batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                     covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                     <span class="co">#plot_convergence = FALSE,</span></span>
<span>                                     iterations <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; No blocking variable specified. </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; Joint probability that the final layout is balanced: 0.9970577</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span>
<span></span>
<span><span class="co"># plot run times</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"brute_force"</span>, <span class="st">"simulated_annealing"</span><span class="op">)</span>,</span>
<span>           time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">runtime_brute_force</span>, <span class="va">runtime_optimal</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">time</span>, fill <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span></span></code></pre>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-12-2.png" width="672">
In addition to generating a more balanced layout, we see that the
machine learning approach also achieves this in less run time.</p>
</div>
<div class="section level3">
<h3 id="blocking">Blocking<a class="anchor" aria-label="anchor" href="#blocking"></a>
</h3>
<p>There is a adage on the design of experiments, commonly attributed to
George Box, to “block what you can, randomise what you cannot”. We have
discussed the limitations of randomisation in situations where the
covariates for all samples are already known in advance. However, the
advice to block variables is still relevant, and we also implement
functionality to block samples within batches by a specified variable.
This can be performed as follows:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimal_layout_blocked</span> <span class="op">=</span> <span class="fu"><a href="../reference/allocate_samples.html">allocate_samples</a></span><span class="op">(</span><span class="va">toy_data</span>, </span>
<span>                                 batch_size <span class="op">=</span> <span class="fl">13</span>, </span>
<span>                                 covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span>,</span>
<span>                                 blocking_variable <span class="op">=</span> <span class="st">"block_id"</span>,</span>
<span>                                 iterations <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                 method <span class="op">=</span> <span class="st">"simulated_annealing"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Blocking variable:  block_id </span></span>
<span><span class="co">#&gt; Covariate: covariate1 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate2 - continuous</span></span>
<span><span class="co">#&gt; Covariate: covariate3 - categorical</span></span>
<span><span class="co">#&gt; Number of samples: 98</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<pre><code><span><span class="co">#&gt; Joint probability that the final layout is balanced: 0.999972</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(covariate1, covariate2, covariate3, block_id,</span></span>
<span><span class="co">#&gt; sample_id)`</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="plot-an-overview-of-the-layout">plot an overview of the layout<a class="anchor" aria-label="anchor" href="#plot-an-overview-of-the-layout"></a>
</h3>
<p>In order to easily get an overview of the balance of a particular
layout, we provide a simple function to plot the levels of covariates
across the batches.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_layout.html">plot_layout</a></span><span class="op">(</span><span class="va">optimal_layout_blocked</span>, covariates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"covariate1"</span>, <span class="st">"covariate2"</span>, <span class="st">"covariate3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 12 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<p><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-14-1.png" width="672"><img src="methods_for_sample_allocation_to_batches_files/figure-html/unnamed-chunk-14-2.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="session-info">session info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.4.1 (2024-06-14)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.5 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] ggplot2_3.5.1              dplyr_1.1.4               </span></span>
<span><span class="co">#&gt; [3] SampleAllocateR_0.0.0.9000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] gtable_0.3.6      jsonlite_1.8.9    highr_0.11        compiler_4.4.1   </span></span>
<span><span class="co">#&gt;  [5] tidyselect_1.2.1  tidyr_1.3.1       jquerylib_0.1.4   systemfonts_1.1.0</span></span>
<span><span class="co">#&gt;  [9] scales_1.3.0      textshaping_0.4.0 yaml_2.3.10       fastmap_1.2.0    </span></span>
<span><span class="co">#&gt; [13] R6_2.5.1          labeling_0.4.3    generics_0.1.3    knitr_1.48       </span></span>
<span><span class="co">#&gt; [17] tibble_3.2.1      desc_1.4.3        munsell_0.5.1     bslib_0.8.0      </span></span>
<span><span class="co">#&gt; [21] pillar_1.9.0      rlang_1.1.4       utf8_1.2.4        cachem_1.1.0     </span></span>
<span><span class="co">#&gt; [25] xfun_0.48         fs_1.6.4          sass_0.4.9        cli_3.6.3        </span></span>
<span><span class="co">#&gt; [29] withr_3.0.2       pkgdown_2.1.1     magrittr_2.0.3    digest_0.6.37    </span></span>
<span><span class="co">#&gt; [33] grid_4.4.1        lifecycle_1.0.4   vctrs_0.6.5       evaluate_1.0.1   </span></span>
<span><span class="co">#&gt; [37] glue_1.8.0        farver_2.1.2      ragg_1.3.3        fansi_1.0.6      </span></span>
<span><span class="co">#&gt; [41] colorspace_2.1-1  purrr_1.0.2       rmarkdown_2.28    tools_4.4.1      </span></span>
<span><span class="co">#&gt; [45] pkgconfig_2.0.3   htmltools_0.5.8.1</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Mulvey.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
